# 风电预测系统数据库迁移指南

本文档提供了风电预测系统数据库迁移的详细指导，包括模型定义规范、迁移操作步骤以及跨环境迁移策略。

## 1. 模型定义规范

### 1.1 模型组织结构

所有SQLAlchemy模型必须遵循以下组织结构：

```
wind-power-forecast/backend/db_models/
  ├── __init__.py           # 导入并导出所有模型
  ├── base.py               # 定义Base和通用混入类
  ├── dataset.py            # 数据集相关模型
  ├── power.py              # 功率数据相关模型
  ├── training.py           # 训练相关模型
  ├── user.py               # 用户相关模型
  ├── task.py               # 任务历史相关模型
  ├── training_history.py   # 训练历史记录模型
  └── user_roles.py         # 用户角色模型
```

### 1.2 模型定义要求

1. **Base继承**：所有模型必须继承自`db_models.base.Base`
2. **表名命名**：使用小写下划线命名法，例如：`user_roles`, `training_history`
3. **列定义**：清晰指定数据类型、约束和注释
4. **关系定义**：明确定义外键关系和引用
5. **__repr__方法**：每个模型都应实现`__repr__`方法，便于调试

### 1.3 添加新模型

添加新模型时，遵循以下步骤：

1. 在`db_models/`目录下创建适当的模块文件
2. 在模块中定义模型类，继承`Base`
3. 在`db_models/__init__.py`中导入新模型
4. 生成新的迁移脚本

## 2. 迁移操作指南

### 2.1 初始化数据库迁移

第一次设置项目时（只需执行一次）：

```bash
# 初始化Alembic
alembic init migration
```

### 2.2 生成迁移脚本

当模型定义变更时，生成迁移脚本：

```bash
# 生成迁移脚本（自动检测模型变更）
alembic revision --autogenerate -m "描述变更内容"
```

### 2.3 检查生成的迁移脚本

在应用迁移前，务必检查生成的脚本（位于`migration/versions/`目录）：

1. 验证`upgrade()`函数中的变更是否符合预期
2. 检查`downgrade()`函数是否正确定义了回滚操作
3. 特别注意表删除操作，确保这些操作是有意的

### 2.4 应用迁移

应用迁移到数据库：

```bash
# 应用所有未应用的迁移
alembic upgrade head

# 或应用到特定版本
alembic upgrade <revision_id>
```

### 2.5 回滚迁移

如需回滚到之前的版本：

```bash
# 回滚一个版本
alembic downgrade -1

# 回滚到特定版本
alembic downgrade <revision_id>

# 回滚到最初状态
alembic downgrade base
```

### 2.6 查看迁移状态

```bash
# 查看当前数据库版本
alembic current

# 查看历史和未应用的迁移
alembic history
```

## 3. 跨环境迁移策略

### 3.1 开发到测试环境

1. 在开发环境生成并测试迁移脚本
2. 将迁移脚本纳入版本控制
3. 在测试环境执行：`alembic upgrade head`

### 3.2 测试到生产环境

1. **备份生产数据库**（重要！）
2. 在生产环境执行：`alembic upgrade head`
3. 验证数据完整性

### 3.3 不同数据库引擎迁移

从PostgreSQL迁移到其他数据库引擎（如MySQL、SQLite）时的注意事项：

1. **类型兼容性**：检查和调整特定于PostgreSQL的类型（如JSONB）
2. **序列与自增**：不同数据库处理自增字段的方式可能不同
3. **约束命名**：调整约束命名以符合目标数据库的规范
4. **文本编码**：确保文本编码兼容性

具体迁移步骤：

1. 修改`alembic.ini`中的数据库连接字符串
2. 调整`env.py`中的数据库URI获取逻辑
3. 可能需要手动调整现有迁移脚本以处理数据库特性差异

## 4. 常见问题与解决方案

### 4.1 迁移脚本生成问题

**问题**：未检测到模型变更  
**解决**：确保`env.py`正确导入所有模型，检查模型是否继承自正确的`Base`

**问题**：生成了意外的`DROP TABLE`操作  
**解决**：这通常表示数据库中有表但模型定义中没有，检查模型定义完整性

### 4.2 迁移应用问题

**问题**：`KeyError: 'url'`  
**解决**：确保`env.py`中正确设置了`sqlalchemy.url`参数

**问题**：表已存在错误  
**解决**：检查迁移历史是否同步，可能需要标记已应用的迁移：`alembic stamp <revision_id>`

### 4.3 性能考量

对于生产环境中的大型数据库：

1. 避免在高峰期执行迁移
2. 对于大表结构变更，考虑使用批处理方法
3. 先在复制的数据库上测试迁移性能

## 5. 最佳实践总结

1. **频繁小变更**：优先考虑频繁的小规模迁移，而不是大型变更
2. **完整测试**：在应用到生产前，在测试环境完全测试迁移
3. **回滚计划**：始终准备回滚计划和备份
4. **记录变更**：在迁移描述中详细记录更改目的和内容
5. **保持模型与迁移同步**：确保模型定义和迁移脚本保持同步

## 6. 相关资源

- [Alembic官方文档](https://alembic.sqlalchemy.org/)
- [SQLAlchemy官方文档](https://docs.sqlalchemy.org/) 